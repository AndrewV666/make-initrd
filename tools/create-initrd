#!/bin/sh -eu

. sh-functions

cd "$rootdir"

mkdir $verbose -p -- \
	./conf \
	./dev \
	./etc/modprobe.d \
	./etc/udev/rules.d \
	./"$kernel_modules_dir" \
	./lib/udev \
	./mnt \
	./root \
	./run \
	./proc \
	./sys \
	./tmp \
	./var/lock \
	#

verbose "Copying files from libnss_files.so* ..."
for lib in /lib64 /lib; do
	[ ! -d "$lib" ] ||
		find $lib -mindepth 1 -maxdepth 1 -name 'libnss_files.so*' -exec put-file '{}' '+'
done

echo 'root:x:0:0::/root:/bin/sh' >./etc/passwd
echo 'root:x:0:' >./etc/group
echo '' >./etc/services

cat >./etc/nsswitch.conf <<EOF
passwd: files
group: files
services: files
EOF

[ -z "${PUT_DIRS-}"  ] || put-tree $PUT_DIRS
[ -z "${PUT_FILES-}" ] || put-file $PUT_FILES

# initrd specific files
put-tree "$datadir"

:>>./etc/fstab

if [ ! -x ./bin/sh ]; then
	for n in bash dash mksh ash; do
		[ -x ./bin/$n ] || continue
		verbose "Setting $n as /bin/sh ..."
		ln -s $n ./bin/sh
		break
	done
fi

if [ -f /etc/modprobe.conf ]; then
	verbose "Copying /etc/modprobe.conf ..."
	put-file /etc/modprobe.conf
fi

for d in lib etc; do
	if [ -d "/$d/modprobe.d" ]; then
		verbose "Copying files from $d/modprobe.d ..."
		find -L "/$d/modprobe.d" \
				-name '*.conf' \
			-exec cp -aLt ./etc/modprobe.d -- '{}' '+'
	if

	if [ -d "/$d/udev/initramfs-rules.d" ]; then
		verbose "Copying files from /$d/udev/initramfs-rules.d ..."
		find -L "/$d/udev/initramfs-rules.d" \
				-name '*.rules' \
			-exec cp -aLt ./etc/udev/rules.d -- '{}' '+'
	fi
done
