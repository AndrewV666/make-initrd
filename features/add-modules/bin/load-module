#!/bin/sh -efu

. sh-functions

. shell-signal

modules_file='/etc/initrd/modules-postudev'
modules_list=
modules_check=

while [ "$#" -gt 0 ]; do
	case "$1" in
		--pre-udev)
			modules_file='/etc/initrd/modules-preudev'
			;;
		--post-udev)
			modules_file='/etc/initrd/modules-postudev'
			;;
		--check) shift
			[ -x "$1" ] ||
				fatal "Not executable: $1"
			modules_check="$1"
			;;
		*)
			modules_list="$modules_list ${1##*/}"
			;;
	esac
	shift
done

workdir=
exit_handler()
{
	[ -z "$workdir" ] || rm -rf -- "$workdir"
}

workdir="$(mktemp -dt "$PROG.XXXXXXXXX")"
set_cleanup_handler exit_handler

add_module_callback() {
	printf '%s\n' "$@" >> "$workdir/list"
}

for n in $modules_list; do
	! grep -F -xqs "$n" "$rootdir/$modules_file" ||
		continue

	add-module "$n"
	printf '%s\n' "$n" >> "$rootdir/$modules_file"

	if [ -n "$modules_check" ]; then
		mkdir -p -- "$rootdir/lib/initrd/kmodules"
		cp -a -- "$modules_check" "$rootdir/lib/initrd/kmodules/check-$n"
	fi
done

[ ! -s "$workdir/list" ] ||
	xargs -r put-file "$rootdir" < "$workdir/list"
