#!/bin/sh -eu

. shell-error
. ${TOOLSDIR:?}/sh-functions

cd "$rootdir"

mkdir -p -- ./etc ./dev ./safedev ./loopfs ./mnt ./sys ./proc ./lib/modules/"$kernel"

[ -e ./dev/ram     ]	|| mknod ./dev/ram	b 1 1
[ -e ./dev/null    ]	|| mknod ./dev/null	c 1 3
[ -e ./dev/zero    ]	|| mknod ./dev/zero	c 1 5
[ -e ./dev/full    ]	|| mknod ./dev/full	c 1 7
[ -e ./dev/systty  ]	|| mknod ./dev/systty	c 4 0
[ -e ./dev/tty1    ]	|| mknod ./dev/tty1	c 4 1
[ -e ./dev/console ]	|| mknod ./dev/console	c 5 1

mkdir -p -- \
	./etc \
	./etc/modprobe.d \
	./etc/udev/rules.d \
	./lib/udev \
	./conf \
	./tmp

cp -at . \
	"$datadir"/* \
	/lib/busybox-initramfs/*

put-program \
	/bin/ash \
	/lib/udev/ata_id \
	/lib/udev/cdrom_id \
	/lib/udev/edd_id \
	/lib/udev/firmware \
	/lib/udev/path_id \
	/lib/udev/scsi_id \
	/lib/udev/usb_id \
	/lib/udev/vol_id \
	/sbin/udevadm \
	/sbin/udevd \
	/sbin/modprobe \
#


ln -s ash ./bin/sh

ldconfig -f /dev/null -r $rootdir /lib

add-module $MODULES_ADD
load-module $MODULES_LOAD
/sbin/depmod -a -F "/boot/System.map-$KERNEL" -b . "$KERNEL"

[ ! -f /etc/modprobe.conf ] ||
	put-file /etc/modprobe.conf

[ ! -d /etc/modprobe.d ] ||
	find -L /etc/modprobe.d \
		\( \
			\! -name '*.rpm*' -a \
			\! -name '*~' \
		\) \
		-exec put-file '{}' '+'

[ ! -d /etc/udev/initramfs-rules.d ] ||
	find -L /etc/udev/initramfs-rules.d/ \
			-name '*.rules' \
		-exec cp -aLt ./etc/udev/rules.d -- '{}' '+'
