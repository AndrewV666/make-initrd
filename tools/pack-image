#!/bin/sh -eu

. sh-functions

cd "$rootdir"

# Hack
grep -l 'BEGIN INIT INFO' ./etc/rc.d/init.d/* |
while read f; do
	name="${f##*/}"
	chroot . chkconfig --add "$name"
done

find -O2 -mindepth 1 \
	   \( -type f -a -printf 'file %p %p %#m 0 0\n'  \) \
	-o \( -type l -a -printf 'slink %p %l %#m 0 0\n' \) \
	-o \( -type d -a -printf 'dir %p %#m 0 0\n'      \) \
	-o \( -type p -a -printf 'pipe %p %#m 0 0\n'     \) \
	-o \( -type s -a -printf 'sock %p %#m 0 0\n'     \) \
	> "$workdir"/initcpio

printf >> "$workdir"/initcpio 'slink %s 0777 0 0\n' \
	"/proc/kcore /dev/core" \
	"/proc/self/fd /dev/fd" \
	"/proc/self/fd/0 /dev/stdin"  \
	"/proc/self/fd/1 /dev/stdout" \
	"/proc/self/fd/2 /dev/stderr"

printf >> "$workdir"/initcpio 'nod ./dev/%s\n' \
	"ram     0644 0 0 b 1 1" \
	"null    0666 0 0 c 1 3" \
	"zero    0666 0 0 c 1 5" \
	"full    0666 0 0 c 1 7" \
	"random  0666 0 0 c 1 8" \
	"systty  0666 0 0 c 4 0" \
	"tty0    0666 0 0 c 4 0" \
	"tty1    0666 0 0 c 4 1" \
	"tty     0666 0 0 c 5 0" \
	"console 0600 0 0 c 5 1" \
	"ptmx    0666 0 0 c 5 2"

# Hack
for init in /sbin/init.initrd /sbin/init; do
	[ -f "$init" ] || continue
	printf >> "$workdir"/initcpio 'file ./sbin/init-bin %s 700 0 0\n' "$init"
	break
done
printf >> "$workdir"/initcpio 'pipe ./.initrd/shell 666 0 0\n'

gen_init_cpio "$workdir"/initcpio > "$outfile"
