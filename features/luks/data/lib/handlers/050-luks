#!/bin/sh

. /scripts/functions

nameluks=
password=
handler() {
	nameluks="${INIT_LUKS##*/}-luks"

	# skip if $nameluks has already exist
        dmsetup info "$nameluks" >/dev/null 2>&1 &&
                return 0 ||:

	cryptsetup --key-file=- luksOpen "$INIT_LUKS" "$nameluks"
	retcode="$?"

	if [ "$retcode" != "0" ]; then
		error "Unable to activate LUKS: $retcode"
		return 1
	fi
}

rc=0
for e in "$handler_eventdir"/luks/*; do
	[ -f "$e" ] || break

	( . "$e"; handler; ) ||
		rc=1
done

exit $rc
