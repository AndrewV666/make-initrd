#!/bin/sh -efu

. sh-functions
. module-functions

. shell-error
. shell-signal

ignore_missing=
if [ "${1-}" = '--optional' ]; then
	ignore_missing=1
	shift
fi

workdir=
exit_handler()
{
	[ -z "$workdir" ] || rm -rf -- "$workdir"
}

workdir="$(mktemp -dt "$PROG.XXXXXXXXX")"
set_cleanup_handler exit_handler

add_module_callback() {
	printf '%s\n' "$@" >> "$workdir/list"
}

for n; do
	if [ -n "${n##*[/\[\].*&^\$\\\\/]*}" ]; then
		n="$(normalize_modname "$n")"
		add_module "$n"
		continue
	fi

	if [ -n "${KERNEL_MODULES-}" ]; then
		find "$KERNEL_MODULES" -type f | { grep -E -e "$n" || :>"$workdir/abort"; } |
		while read -r m; do
			add_module "$m"
		done
		[ -e "$workdir/abort" ] ||
			continue
	fi

	fatal "Unable to handle pattern: $n"
done

[ ! -s "$workdir/list" ] ||
	xargs -r put-file "$rootdir" < "$workdir/list"
