#!/usr/bin/make -rf
.EXPORT_ALL_VARIABLES:
.DEFAULT_GOAL := all

include @PREFIX@/config.mk
include @PREFIX@/initfiles.mk
include @PREFIX@/rules.mk

ifneq "$(strip $(INITRD_CONFIG))" ''

# Load user configuration
include $(INITRD_CONFIG)

# Load guessed parameters
ifeq ($(MAKECMDGOALS),genimage)
include $(WORKDIR)/guess/guessed.mk
endif

# Load requested features
ifneq "$(strip $(FEATURES))" ''
include $(call require,$(FEATURES))
endif # FEATURES

endif # INITRD_CONFIG

all:
	@for c in $(INITRD_CONFIG_LIST); do \
		echo "Config file: $$c"; \
		wsuffix="$${c##*/}"; \
		wsuffix="$${wsuffix%.mk}"; \
		export WORKDIR_SUFFIX="$$wsuffix"; \
		export INITRD_CONFIG="$$c"; \
		$(TOOLSDIR)/run-make $(MAKE) $(MFLAGS) -f $(MAKE_INITRD_BIN) guess; \
		$(TOOLSDIR)/run-make $(MAKE) $(MFLAGS) -f $(MAKE_INITRD_BIN) genimage; \
	done

guess:
	@mkdir -m 755 -p -- $(WORKDIR)/guess
	@cat /dev/null > $(WORKDIR)/guess/modules
	@cat /dev/null > $(WORKDIR)/guess/modalias
	@cat /dev/null > $(WORKDIR)/guess/features
	@for i in $(AUTODETECT); do \
		if [ -z "$${i##*:*}" ]; then \
			"$(TOOLSDIR)/guess-$${i%%:*}" "$${i#*:}"; \
		else \
			"$(TOOLSDIR)/guess-$$i"; \
		fi;\
	done
	@$(TOOLSDIR)/guess-config > $(WORKDIR)/guess/guessed.mk

guess-config: AUTODETECT ?= common root resume
guess-config: guess check-for-root
	@cat $(WORKDIR)/guess/guessed.mk
	$Qrm -rf -- "$(WORKDIR)"

bug-report: check-for-root
	@mkdir -m 755 -p -- $(WORKDIR)
	@$(TOOLSDIR)/bug-report
	$Qrm -rf -- "$(WORKDIR)"
