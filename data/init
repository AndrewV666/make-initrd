#!/bin/sh

export PATH=/bin:/sbin:/usr/bin:/usr/sbin

export RUN_INITRD=1
export INIT='/sbin/init'
export QUIET=
export PANIC=
export STOP=','
export IGNORE=','
export rootmnt='/root'
export readonly=1
export RESCUE_MODULES=

[ ! -s /conf/initramfs.conf ] || . /conf/initramfs.conf
. /scripts/functions

run_scripts top

for m in /modules/*; do
	[ -x "$m" ] ||
		continue

	export stage="${m#*-}"

	[ -n "${IGNORE##*,$stage,*}" ] ||
		continue

	run_scripts "pre/$stage"

	. "$m"
	verbose "$msg"

	[ "$STOP" != ',all,' -a -n "${STOP##*,$stage,*}" ] ||
		shell "Spawning shell within the initramfs"

	run "$@" ||
		shell "Stage '$stage' failed"

	run_scripts "post/$stage"
done
