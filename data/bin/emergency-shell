#!/bin/sh -eu

[ ! -f /.initrd/initenv ] ||
	. /.initrd/initenv

if [ -z "${ESHELL_NOMESSAGE-}" ]; then
	if [ -z "${ESHELL_MESSAGE-}" ]; then
		fifo=/.initrd/shell
		if [ -e "$fifo" ]; then
			read msg < "$fifo" ||:
			[ -z "${msg-}" ] || printf '%s: %s\n' "${0##*/}" "$msg"
		fi
	else
		printf '%s: %s\n' "${0##*/}" "$ESHELL_MESSAGE"
	fi
fi

lock=/.initrd/shell.lock
/bin/mkdir "$lock" >/dev/null 2>&1 ||
	exit 0

for f in /lib/shell/*; do
	[ -x "$f" ] || break
	"$f" ||:
done

PS1='(initramfs)$ ' setsid -cw /bin/sh
/bin/rmdir "$lock"
