#!/bin/sh -eu

. /.initrd/initenv
. shell-error

msg=
[ -n "${RDSHELL-}" ] ||
	read msg < /.initrd/shell

mkdir /.initrd/shell.lock >/dev/null 2>&1 ||
	exit 0

# Disallow console access
[ "${PANIC-}" != 0 ] || reboot

for f in /lib/shell/*; do
	[ -x "$f" ] || break
	"$f"
done

[ -z "$msg" ] || message "$msg"

rc=0
PS1='(initramfs)$ ' /bin/sh -i +m || rc=$?
echo

rmdir /.initrd/shell.lock
exit $rc
